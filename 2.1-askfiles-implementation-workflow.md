# AskFiles Implementation Workflow

**Created:** 2026-01-28 15:45 CET  
**Based on:** everything-claude-code + Boris Cherny's workflow  
**Purpose:** Production-ready development workflow with validation

---

## Workflow Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ASKFILES IMPLEMENTATION WORKFLOW               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. PLAN PHASE (using planner agent)                        â”‚
â”‚     â†’ Break down issue into detailed steps                  â”‚
â”‚     â†’ Identify files, dependencies, risks                   â”‚
â”‚     â†’ Get approval before coding                            â”‚
â”‚                                                             â”‚
â”‚  2. IMPLEMENT PHASE (TDD workflow)                          â”‚
â”‚     â†’ Write tests first (RED)                               â”‚
â”‚     â†’ Implement code (GREEN)                                â”‚
â”‚     â†’ Refactor (IMPROVE)                                    â”‚
â”‚     â†’ PostToolUse hooks run automatically:                  â”‚
â”‚       - Format code (php-cs-fixer, prettier)                â”‚
â”‚       - Check for console.log                               â”‚
â”‚       - Run linters                                         â”‚
â”‚                                                             â”‚
â”‚  3. REVIEW PHASE (code-reviewer agent)                      â”‚
â”‚     â†’ Security checks (critical)                            â”‚
â”‚     â†’ Code quality (high)                                   â”‚
â”‚     â†’ Performance (medium)                                  â”‚
â”‚     â†’ Best practices (medium)                               â”‚
â”‚                                                             â”‚
â”‚  4. VERIFICATION PHASE (verification loop)                  â”‚
â”‚     â†’ Run test suite (PHPUnit, Vitest)                      â”‚
â”‚     â†’ Check coverage (80%+ required)                        â”‚
â”‚     â†’ E2E test (upload PDF â†’ search)                        â”‚
â”‚     â†’ Manual browser test                                   â”‚
â”‚                                                             â”‚
â”‚  5. COMMIT PHASE (automated)                                â”‚
â”‚     â†’ git add, commit with proper message                   â”‚
â”‚     â†’ Push to GitHub                                        â”‚
â”‚     â†’ Close issue with "Closes #X"                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 1: Planning (Before Any Code)

### Command: `/plan <issue-number>`

**What it does:**
1. Reads issue description
2. Analyzes existing codebase
3. Creates detailed implementation plan
4. Shows you the plan for approval

**Example:**
```bash
/plan 103  # Plan for knowledge_bases migration
```

**Output:**
```markdown
# Implementation Plan: Knowledge Bases Migration

## Overview
Create Laravel migration and Eloquent model for knowledge_bases table.

## Files to Create/Modify
- database/migrations/YYYY_MM_DD_create_knowledge_bases_table.php
- app/Models/KnowledgeBase.php
- tests/Unit/Models/KnowledgeBaseTest.php

## Implementation Steps

### Step 1: Create Migration
File: database/migrations/YYYY_MM_DD_create_knowledge_bases_table.php
- Add uuid primary key
- Add title, slug (unique, indexed)
- Add file_count, chunk_count (default 0)
- Add timestamps
Risk: Low

### Step 2: Create Model
File: app/Models/KnowledgeBase.php
- Use HasUuids trait
- Add fillable fields
- Add casts (slug â†’ string, counts â†’ integer)
Risk: Low

### Step 3: Write Tests
File: tests/Unit/Models/KnowledgeBaseTest.php
- Test model creation
- Test slug uniqueness
- Test default values
Risk: Low

## Testing Strategy
- Unit test: Model creation and relationships
- Integration test: Database operations
```

**Your role:** Review plan, approve, or request changes.

---

## Phase 2: Implementation (TDD Workflow)

### Command: `/tdd <issue-number>`

**What it does:**
1. Follows the approved plan
2. Writes tests FIRST (RED phase)
3. Implements minimal code (GREEN phase)
4. Refactors (IMPROVE phase)
5. Runs tests after each phase
6. Shows you only when GREEN

**TDD Cycle:**
```
RED (Write failing test)
    â†“
GREEN (Minimal implementation)
    â†“
IMPROVE (Refactor)
    â†“
RUN TESTS (Verify green)
    â†“
(Repeat for next step)
```

**Automatic Hooks (PostToolUse):**

Every time I write/edit code, these run automatically:

1. **Format Code**
   ```bash
   # Backend
   ./vendor/bin/php-cs-fixer fix {file}
   
   # Frontend
   pnpm prettier --write {file}
   ```

2. **Check for console.log**
   ```bash
   grep -n "console\\.log" {file}
   # Warns if found, must remove before commit
   ```

3. **Run Linters**
   ```bash
   # Backend
   ./vendor/bin/phpstan analyze {file}
   
   # Frontend
   pnpm eslint {file}
   ```

---

## Phase 3: Code Review (Automated)

### Command: `/code-review`

**What it does:**
1. Runs `git diff` to see changes
2. Reviews against checklist
3. Reports issues by priority

**Review Checklist:**

### CRITICAL (Must Fix)
- âŒ Hardcoded credentials
- âŒ SQL injection risks
- âŒ XSS vulnerabilities
- âŒ Missing input validation
- âŒ Exposed API keys

### HIGH (Should Fix)
- âš ï¸ Functions >50 lines
- âš ï¸ Files >800 lines
- âš ï¸ Missing error handling
- âš ï¸ console.log statements
- âš ï¸ Missing tests

### MEDIUM (Consider)
- ğŸ’¡ Inefficient algorithms
- ğŸ’¡ Missing memoization
- ğŸ’¡ Poor variable naming
- ğŸ’¡ Magic numbers

**Output Format:**
```
[CRITICAL] Hardcoded API key
File: app/Services/EmbeddingService.php:12
Found: $apiKey = "sk-..."
Fix: Use config('services.openai.key')

[HIGH] Missing error handling
File: app/Http/Controllers/KnowledgeBaseController.php:45
Missing: try/catch around $this->qdrant->search()
Add: Catch QdrantException and return 500

[MEDIUM] Poor variable naming
File: app/Services/QdrantService.php:23
Found: $x = $this->client->...
Fix: Rename to $searchResults
```

---

## Phase 4: Verification Loop

### Command: `/verify`

**What it does:**
1. Runs full test suite
2. Checks coverage
3. Runs E2E tests
4. Opens browser for manual test

**Verification Steps:**

### Backend Tests
```bash
cd api
./vendor/bin/phpunit
# Must: All green
# Must: 80%+ coverage
```

### Frontend Tests
```bash
cd client
pnpm test:unit
pnpm test:e2e
# Must: All green
# Must: 80%+ coverage
```

### E2E Verification (Critical)
```bash
# 1. Start services
tmux new -s askfiles-test
# Window 1: Backend
cd api && php artisan serve

# Window 2: Frontend  
cd client && pnpm dev

# Window 3: Test
pnpm test:e2e -- upload-to-search.spec.ts
```

### Manual Browser Test
1. Open http://localhost:3000
2. Upload a PDF
3. Wait for processing (show spinner)
4. Get redirected to /kb/{id}
5. Search: "What is this document about?"
6. Verify: Results show with source citations

**Pass criteria:**
- âœ… All automated tests green
- âœ… Coverage â‰¥ 80%
- âœ… E2E test passes
- âœ… Manual test successful
- âœ… No console errors

---

## Phase 5: Commit & Push

### Command: `/commit-push-pr`

**What it does:**
1. Stages changes (git add)
2. Creates commit with proper format
3. Pushes to GitHub
4. Closes issue automatically

**Commit Format:**
```
feat(backend): create knowledge_bases migration and model

- Add migration with uuid primary key
- Create KnowledgeBase model with HasUuids trait
- Add unit tests with 85% coverage
- Verify slug uniqueness constraint

Closes #103
```

**Automatic Checks (PreCommit Hook):**
```bash
# 1. Run tests
./vendor/bin/phpunit || exit 1

# 2. Check code style
./vendor/bin/php-cs-fixer fix --dry-run || exit 1

# 3. Check for debug statements
! git diff --cached | grep -i "console.log\|var_dump\|dd(" || exit 1

# 4. Verify no secrets
! git diff --cached | grep -iE "api.key|password|secret" || exit 1
```

---

## Agents Used

### 1. Planner Agent
**File:** `.claude/agents/planner.md`  
**Purpose:** Creates detailed implementation plans  
**Model:** Opus (for quality)  
**Tools:** Read, Grep, Glob  
**When:** Before any implementation

### 2. TDD Guide Agent
**File:** `.claude/agents/tdd-guide.md`  
**Purpose:** Guides test-driven development  
**Model:** Sonnet (for speed)  
**Tools:** Read, Write, Edit, Bash  
**When:** During implementation

### 3. Code Reviewer Agent
**File:** `.claude/agents/code-reviewer.md`  
**Purpose:** Reviews code for quality, security, maintainability  
**Model:** Opus (for thoroughness)  
**Tools:** Read, Grep, Glob, Bash  
**When:** After implementation, before commit

### 4. Build Error Resolver Agent
**File:** `.claude/agents/build-error-resolver.md`  
**Purpose:** Fixes compilation/test errors  
**Model:** Sonnet (for speed)  
**Tools:** Read, Edit, Bash  
**When:** When tests fail

---

## Hooks Configuration

### PreToolUse Hooks

#### Block Dev Servers Outside tmux
```json
{
  "matcher": "tool == \"Bash\" && tool_input.command matches \"(php artisan serve|pnpm dev)\"",
  "hooks": [{
    "type": "command",
    "command": "echo '[Hook] Dev servers must run in tmux' && exit 1"
  }]
}
```

#### Remind About Tests Before Push
```json
{
  "matcher": "tool == \"Bash\" && tool_input.command matches \"git push\"",
  "hooks": [{
    "type": "command",
    "command": "./vendor/bin/phpunit && pnpm test"
  }]
}
```

### PostToolUse Hooks

#### Auto-Format Code
```json
{
  "matcher": "tool == \"Write\" || tool == \"Edit\"",
  "hooks": [{
    "type": "command",
    "command": "./vendor/bin/php-cs-fixer fix $file_path || pnpm prettier --write $file_path"
  }]
}
```

#### Check for console.log
```json
{
  "matcher": "tool == \"Write\" && tool_input.file_path matches \"\\\\.(ts|tsx|js|jsx|vue)$\"",
  "hooks": [{
    "type": "command",
    "command": "grep -n 'console\\\\.log' \"$file_path\" && echo '[Hook] Remove console.log' || true"
  }]
}
```

---

## CLAUDE.md - Team Learnings

**File:** `/root/ejaj-media/CLAUDE.md`

This file grows as we learn:

```markdown
# AskFiles - Claude Learnings

## Mistakes to Avoid

### 2026-01-28 - Vector Search Issue
- **Problem:** Forgot to embed query before searching Qdrant
- **Solution:** Always call $this->embeddingService->embed() first
- **Code:**
  ```php
  // WRONG
  $results = $this->qdrant->search($query);
  
  // RIGHT
  $vector = $this->embedding->embed($query);
  $results = $this->qdrant->search($vector);
  ```

### 2026-01-28 - Chunking Error
- **Problem:** Chunks too large (>2000 chars) caused embedding failures
- **Solution:** Keep chunks 500-1000 chars max
- **Code:** See app/Services/ChunkingService.php:chunkText()

## Best Practices

### Laravel Services
- Always inject via constructor (DI)
- Return types on all methods
- Use DTOs for complex params
- Wrap external APIs in try/catch

### Nuxt Composables
- Use `useAsyncData` for SSR
- Return refs, not raw values
- Handle loading/error states
- Name consistently: `use{Feature}`

### Testing
- One assertion per test (prefer)
- Use factories for test data
- Mock external services (OpenAI, Qdrant)
- E2E tests for critical flows only

## Coding Style

### PHP
- PSR-12 compliance (php-cs-fixer)
- Typed properties (PHP 8+)
- Readonly where possible
- Enums over constants

### TypeScript
- Strict mode enabled
- No `any` type (use `unknown`)
- Interface over type for objects
- Explicit return types on functions

## PR Template
```markdown
## What
Brief description

## Why
Context and reasoning

## Testing
- [ ] Unit tests pass
- [ ] E2E test passes
- [ ] Manual test in browser

## Screenshots
(if UI change)
```
```

---

## Issue Workflow (Complete Example)

### Issue #103: Create knowledge_bases Migration & Model

#### Step 1: Plan
```bash
/plan 103
```

**Output:** Detailed plan (shown above)  
**Action:** You approve

#### Step 2: Implement (TDD)
```bash
/tdd 103
```

**What happens:**
1. I write test: `KnowledgeBaseTest.php::testCreation()`
2. Run test â†’ FAILS (red)
3. Create migration
4. Create model
5. Run test â†’ PASSES (green)
6. Refactor if needed
7. Run test â†’ PASSES (still green)
8. Show you working code

**PostToolUse hooks run automatically:**
- Format PHP (php-cs-fixer)
- Check PHPStan
- Run tests

#### Step 3: Review
```bash
/code-review
```

**Output:**
```
âœ“ No critical issues
âœ“ No high-priority issues
ğŸ’¡ [MEDIUM] Consider adding docblock to KnowledgeBase::create()
```

**Action:** Fix if needed, or approve

#### Step 4: Verify
```bash
/verify
```

**Output:**
```
âœ“ PHPUnit: 15 tests, 15 passed (0.5s)
âœ“ Coverage: 87%
âœ“ No console.log found
âœ“ No hardcoded secrets
```

#### Step 5: Commit
```bash
/commit-push-pr
```

**Happens automatically:**
```bash
git add .
git commit -m "feat(backend): create knowledge_bases migration and model

- Add migration with uuid primary key
- Create KnowledgeBase model with HasUuids trait
- Add unit tests with 87% coverage

Closes #103"
git push origin main
gh issue close 103
```

**Time:** ~15 minutes for a simple issue  
**Quality:** Production-ready, tested, reviewed

---

## Speed vs Quality Knobs

### Fast Mode (Development)
```bash
# Use Sonnet for speed
model: sonnet

# Skip some tests
SKIP_E2E=1 /verify

# Auto-accept code review warnings
/code-review --auto-fix
```

### Quality Mode (Production)
```bash
# Use Opus for quality
model: opus

# Full test suite
/verify --full

# Manual review required
/code-review --strict
```

---

## Next Steps

1. **Install agents** to `.claude/agents/`
2. **Install hooks** to `.claude/settings.json`
3. **Create CLAUDE.md** in repo root
4. **Install dev tools** (PHP, Composer, Node)
5. **Start with issue #103** using this workflow

---

## File Checklist

To enable this workflow, we need:

- [ ] `.claude/agents/planner.md`
- [ ] `.claude/agents/tdd-guide.md`
- [ ] `.claude/agents/code-reviewer.md`
- [ ] `.claude/agents/build-error-resolver.md`
- [ ] `.claude/settings.json` (with hooks)
- [ ] `CLAUDE.md` (team learnings)
- [ ] `/commands/plan.md`
- [ ] `/commands/tdd.md`
- [ ] `/commands/code-review.md`
- [ ] `/commands/verify.md`
- [ ] `/commands/commit-push-pr.md`

**Shall I create these files now?**

---

*This workflow combines everything-claude-code's agent system with Boris Cherny's verification loops for production-quality code.*

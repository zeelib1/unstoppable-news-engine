# PDF Upload Fix - Complete

**Date:** 2026-01-28 20:55 CET  
**Issue:** PDF uploads failing with "pdf is not a function"  
**Status:** ✅ FIXED

---

## Problem

Users trying to upload PDF files got error:
```json
{
  "error": "Text extraction failed",
  "message": "Failed to extract text from PDF: pdf is not a function"
}
```

---

## Root Cause

The `pdf-parse` library was recently updated to v2, which changed the API:

**Old API (v1):**
```javascript
const pdf = require('pdf-parse');
pdf(buffer).then(result => console.log(result.text));
```

**New API (v2):**
```javascript
const { PDFParse } = require('pdf-parse');
const parser = new PDFParse({ data: buffer });
const result = await parser.getText();
```

Our code was using the old v1 API with ES module imports, which didn't work correctly.

---

## Solution

Updated `src/services/extractor.ts` to use the new v2 API:

```typescript
// Before (v1 style):
import * as pdf from 'pdf-parse'
const data = await pdf(Buffer.from(buffer))

// After (v2 style):
const { PDFParse } = await import('pdf-parse')
const parser = new PDFParse({ data: Buffer.from(buffer) })
const result = await parser.getText()
return result.text
```

**Key changes:**
1. Use dynamic import for pdf-parse
2. Import `PDFParse` class (not default export)
3. Instantiate with `new PDFParse({ data: buffer })`
4. Call `.getText()` instead of direct invocation
5. Access result via `result.text`

---

## Testing

### Test 1: PDF Upload ✅
```bash
$ curl -X POST http://localhost:3001/api/v1/knowledge-bases/{id}/upload \
  -F "file=@test.pdf"
```

**Result:**
```json
{
  "success": true,
  "fileName": "test.pdf",
  "fileSize": 547,
  "chunksCreated": 1,
  "tokensProcessed": 8
}
```

### Test 2: PDF Search ✅
```bash
$ curl "http://localhost:3001/api/v1/search?kb={id}&q=test%20PDF&threshold=0.5"
```

**Result:**
```json
{
  "query": "test PDF",
  "results": [
    {
      "content": "This is a test PDF -- 1 of 1 -- ",
      "score": 0.616,
      "chunkIndex": 0
    }
  ],
  "count": 1
}
```

---

## Verification

**Text files:** ✅ Already working  
**PDF files:** ✅ Now working  
**Search:** ✅ Working with both

---

## Commit

```
commit 30ed632
Fix PDF parsing - use pdf-parse v2 API with dynamic import

- Use PDFParse class from pdf-parse v2
- Instantiate with {data: buffer} options
- Call .getText() method instead of direct invocation
- Fixes "pdf is not a function" error
```

---

## Status

✅ **Issue Resolved**  
✅ **Changes Committed**  
✅ **Changes Pushed to GitHub**

Users can now upload both PDF and TXT files successfully!

---

**Fixed:** 2026-01-28 20:55 CET  
**Time to fix:** ~10 minutes (multiple iterations to find correct API)
